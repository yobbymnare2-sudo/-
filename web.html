<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WhatsApp Web</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    :root {
      --primary: #00a884;
      --secondary: #008069;
      --dark: #111b21;
      --panel: #222d34;
      --header: #202c33;
      --text: #e9edef;
      --text-secondary: #8696a0;
      --search: #2a3942;
      --divider: rgba(134, 150, 160, 0.15);
      --danger: #ea4335;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background-color: var(--dark); color: var(--text); height: 100vh; display: flex; overflow: hidden; }

    /* Sidebar */
    .sidebar { width: 30%; min-width: 340px; background: var(--panel); border-right: 1px solid var(--divider); display: flex; flex-direction: column; }
    .side-header { background: var(--header); padding: 10px 16px; height: 59px; display: flex; justify-content: space-between; align-items: center; }
    .profile-pic { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; object-fit: cover; }
    .icons i { margin-left: 24px; color: var(--text-secondary); cursor: pointer; font-size: 20px; }
    
    .search-bar { padding: 8px 12px; background: var(--panel); }
    .search-input { width: 100%; padding: 10px 16px; border-radius: 8px; border: none; background: var(--search); color: var(--text); outline: none; }

    .chat-list { flex: 1; overflow-y: auto; }
    .chat-item { display: flex; align-items: center; padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--divider); }
    .chat-item:hover { background: var(--search); }
    .chat-item.active { background: #2a3942; }
    .chat-info { margin-left: 15px; flex: 1; }
    .chat-name { font-size: 16px; }
    .chat-msg { font-size: 14px; color: var(--text-secondary); margin-top: 4px; }

    /* Main Area */
    .main { flex: 1; display: flex; flex-direction: column; background: url('https://web.whatsapp.com/img/bg-chat-tile_9e8a259308bae1717067ad6637cc7ac3.png') repeat; background-color: #0b141a; position: relative; }

    /* Control Panel (Modal) */
    .control-panel { position: absolute; top: 20px; right: 20px; width: 350px; background: var(--panel); border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); z-index: 100; display: none; overflow: hidden; }
    .control-header { background: var(--secondary); padding: 15px; display: flex; justify-content: space-between; align-items: center; }
    .control-header h3 { font-size: 16px; font-weight: 500; }
    .close-btn { background: none; border: none; color: white; font-size: 18px; cursor: pointer; }
    
    .control-body { padding: 15px; }
    .input-group { margin-bottom: 15px; }
    .input-group label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; }
    .input-group input, .input-group select { width: 100%; padding: 10px; border-radius: 8px; border: none; background: var(--search); color: var(--text); outline: none; }
    
    .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
    .btn { padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px; transition: 0.2s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn:hover { opacity: 0.9; }

    /* Splash */
    .splash { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .splash img { width: 250px; opacity: 0.5; margin-bottom: 30px; }
    .splash h1 { font-weight: 300; margin-bottom: 10px; }

    /* Toast Notification */
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--secondary); color: white; padding: 12px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: none; z-index: 999; }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="side-header">
      <img id="myPic" src="https://files.catbox.moe/f9gwsx.jpg" class="profile-pic" alt="Me">
      <div class="icons">
        <i class="fas fa-cog" onclick="togglePanel()" title="Group Controls"></i>
      </div>
    </div>

    <div class="search-bar">
      <input type="text" class="search-input" placeholder="Search or start new chat" id="searchInput" oninput="filterGroups()">
    </div>

    <div class="chat-list" id="chatList">
      <!-- Groups loaded here -->
      <div style="padding: 20px; text-align: center; color: var(--text-secondary);">Loading groups...</div>
    </div>
  </div>

  <!-- Main Area -->
  <div class="main">
    
    <!-- Splash Screen -->
    <div class="splash" id="splashScreen">
      <img src="https://web.whatsapp.com/img/intro-connection-light_c98cc75f2aa905314d74571a9d4f9c30.jpg" alt="Intro">
      <h1>WhatsApp Web Dashboard</h1>
      <p>Select a group from the sidebar or open Group Controls.</p>
    </div>

    <!-- Control Panel (Hidden by default) -->
    <div class="control-panel" id="controlPanel">
      <div class="control-header">
        <h3><i class="fas fa-tools"></i> Group Controls</h3>
        <button class="close-btn" onclick="togglePanel()"><i class="fas fa-times"></i></button>
      </div>
      <div class="control-body">
        
        <div class="input-group">
          <label>Select Group</label>
          <select id="groupSelect">
            <option value="">-- Select a Group --</option>
          </select>
        </div>

        <div class="input-group">
          <label>Phone Numbers (Comma separated)</label>
          <input type="text" id="targetNumbers" placeholder="e.g. 26371..., 26378...">
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" onclick="makeAdmin()"><i class="fas fa-user-shield"></i> Make Admin</button>
          <button class="btn btn-primary" onclick="addMember()"><i class="fas fa-user-plus"></i> Add Member</button>
          <button class="btn btn-danger" onclick="leaveGroup()"><i class="fas fa-sign-out-alt"></i> Leave Group</button>
        </div>

      </div>
    </div>

  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast">Action Successful</div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const number = params.get('number');
    
    // Elements
    const chatList = document.getElementById('chatList');
    const groupSelect = document.getElementById('groupSelect');
    const searchInput = document.getElementById('searchInput');
    
    // Data Store
    let groupsCache = [];

    // 1. Initialize
    if(!number) window.location.href = '/';

    async function init() {
      await loadProfile();
      await loadGroups();
    }

    async function loadProfile() {
      try {
        const res = await fetch(`/code/me?number=${number}`);
        const data = await res.json();
        if(data.picture) document.getElementById('myPic').src = data.picture;
      } catch(e) {}
    }

    async function loadGroups() {
      try {
        const res = await fetch(`/code/get-groups?number=${number}`);
        const data = await res.json();
        
        if(data.status === 'success' && data.groups) {
          groupsCache = data.groups;
          renderGroups(groupsCache);
          
          // Populate Control Panel Select
          groupSelect.innerHTML = '<option value="">-- Select a Group --</option>';
          data.groups.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.id;
            opt.innerText = g.name;
            groupSelect.appendChild(opt);
          });
        } else {
           chatList.innerHTML = '<div style="padding:20px; text-align:center; color:red">No groups found or session expired.</div>';
        }
      } catch(e) {
        console.error(e);
        chatList.innerHTML = '<div style="padding:20px; text-align:center; color:red">Error loading groups. Is the bot connected?</div>';
      }
    }

    function renderGroups(groups) {
      chatList.innerHTML = '';
      if(groups.length === 0) {
        chatList.innerHTML = '<div style="padding:20px; text-align:center;">No groups found.</div>';
        return;
      }
      
      groups.forEach(g => {
        const div = document.createElement('div');
        div.className = 'chat-item';
        div.onclick = () => {
           groupSelect.value = g.id;
           togglePanel();
        };
        
        // Generate a random color for group icon
        const colors = ['#00a884', '#25d366', '#dc4a38', '#ff6b6b', '#a55eea'];
        const color = colors[Math.floor(Math.random() * colors.length)];
        
        div.innerHTML = `
          <div class="profile-pic" style="background:${color}; display:flex; justify-content:center; align-items:center; font-size:18px;">
            <i class="fas fa-users"></i>
          </div>
          <div class="chat-info">
            <div class="chat-name">${g.name}</div>
            <div class="chat-msg">${g.size} participants</div>
          </div>
        `;
        chatList.appendChild(div);
      });
    }

    function filterGroups() {
      const term = searchInput.value.toLowerCase();
      const filtered = groupsCache.filter(g => g.name.toLowerCase().includes(term));
      renderGroups(filtered);
    }

    function togglePanel() {
      const panel = document.getElementById('controlPanel');
      panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    }

    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      toast.innerText = message;
      toast.style.background = isError ? '#dc3545' : '#00a884';
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 3000);
    }

    // --- ACTIONS ---

    async function makeAdmin() {
      const groupId = groupSelect.value;
      const nums = document.getElementById('targetNumbers').value.split(',').map(n => n.trim()).filter(n => n);
      
      if(!groupId || nums.length === 0) return showToast('Select group and numbers', true);

      try {
        const res = await fetch('/code/group-action', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ number, action: 'promote', groupId, targetNumbers: nums })
        });
        const data = await res.json();
        if(data.status === 'success') showToast('Success! Promoted to Admin.');
        else throw new Error(data.error);
      } catch(e) { showToast(e.message, true); }
    }

    async function addMember() {
      const groupId = groupSelect.value;
      const nums = document.getElementById('targetNumbers').value.split(',').map(n => n.trim()).filter(n => n);
      
      if(!groupId || nums.length === 0) return showToast('Select group and numbers', true);

      try {
        const res = await fetch('/code/group-action', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ number, action: 'add', groupId, targetNumbers: nums })
        });
        const data = await res.json();
        if(data.status === 'success') showToast('Add request sent. (Check WhatsApp for Invite)');
        else throw new Error(data.error);
      } catch(e) { showToast(e.message, true); }
    }

    async function leaveGroup() {
      const groupId = groupSelect.value;
      if(!groupId) return showToast('Select a group', true);
      
      if(!confirm('Are you sure you want to leave this group?')) return;

      try {
        const res = await fetch('/code/group-action', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ number, action: 'leave', groupId, targetNumbers: [] })
        });
        const data = await res.json();
        if(data.status === 'success') {
            showToast('Left group successfully');
            loadGroups(); // Refresh list
        }
        else throw new Error(data.error);
      } catch(e) { showToast(e.message, true); }
    }

    // Start
    init();
  </script>
</body>
</html>
